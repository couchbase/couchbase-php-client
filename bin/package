#!/usr/bin/env ruby

def run(*args)
  args = args.compact.map(&:to_s)
  puts args.join(" ")
  system(*args) || abort("command returned non-zero status: #{args.join(" ")}")
end

project_root = File.expand_path(File.join(__dir__, ".."))

library_revision = Dir.chdir(project_root) { `git rev-parse HEAD`.strip }
core_revision = Dir.chdir(File.join(project_root, "src", "deps", "couchbase-cxx-client")) { `git rev-parse HEAD`.strip }
txn_revision = Dir.chdir(File.join(project_root, "src", "deps", "couchbase-cxx-transactions")) { `git rev-parse HEAD`.strip }
File.write(File.join(project_root, "src", "cmake", "revisions.cmake"), <<~REVISIONS)
  set(EXT_GIT_REVISION #{library_revision.inspect})
  set(COUCHBASE_CXX_CLIENT_GIT_REVISION #{core_revision.inspect})
  set(COUCHBASE_CXX_TRANSACTIONS_GIT_REVISION #{txn_revision.inspect})
REVISIONS

package_xml_path = File.join(project_root, "package.xml")
File.write(
  package_xml_path,
  File
    .read(package_xml_path)
    .gsub(/^ {4}<date>.*<\/date>$/, "    <date>#{Time.now.strftime("%Y-%m-%d")}</date>")
)

Dir.chdir(project_root) do
  run("pecl package")
end
